{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file://D%3A/code/genreshift-web/app/api/transform/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport axios from 'axios';\r\n\r\n// 设置更短的超时时间，适应Vercel环境\r\nconst TIMEOUT_MS = 50000; // 50秒，留些余量\r\n\r\n// 简单的内存缓存，避免重复请求相同内容\r\nconst responseCache = new Map();\r\n// 缓存清理时间（10分钟）\r\nconst CACHE_EXPIRY = 10 * 60 * 1000;\r\n\r\n// 导出配置，设置为Edge Runtime以获得更长的执行时间\r\nexport const config = {\r\n  runtime: 'edge',\r\n};\r\n\r\nexport async function POST(request) {\r\n  try {\r\n    console.log('=========== API调用开始 ===========');\r\n    const start = Date.now();\r\n    const { content, parameters } = await request.json();\r\n    \r\n    // 内容处理 - 缩短长度进一步提高速度\r\n    const contentLimit = 4000; // 减少到4000字符\r\n    const processedContent = content.substring(0, contentLimit);\r\n    \r\n    // 创建缓存键（内容+参数组合）\r\n    const cacheKey = JSON.stringify({\r\n      content: processedContent.substring(0, 100) + processedContent.length, // 只用前100字符+长度作为内容标识\r\n      parameters\r\n    });\r\n    \r\n    // 检查缓存\r\n    if (responseCache.has(cacheKey)) {\r\n      console.log('使用缓存结果，节省API调用');\r\n      return NextResponse.json({\r\n        result: responseCache.get(cacheKey),\r\n        fromCache: true\r\n      });\r\n    }\r\n    \r\n    console.log('内容长度:', processedContent.length);\r\n    console.log('参数:', JSON.stringify(parameters));\r\n    \r\n    if (!processedContent) {\r\n      return NextResponse.json(\r\n        { error: \"请提供论文内容\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    \r\n    // 获取环境变量中的API密钥和URL，如果不存在则使用默认值\r\n    // 这样可以确保即使没有设置环境变量也能正常工作\r\n    const API_KEY = process.env.DASHSCOPE_API_KEY || \"sk-1f660ec6e1584c83825ffeed4b838523\";\r\n    const API_URL = process.env.DASHSCOPE_API_URL || \"https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions\";\r\n    \r\n    if (!API_KEY) {\r\n      return NextResponse.json(\r\n        { error: \"API密钥未配置，请检查环境变量设置\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n    // 构建提示词\r\n    const prompt = `\r\n请将以下学术论文内容转换为易读的科技新闻格式：\r\n\r\n【论文内容】\r\n${processedContent}\r\n\r\n【输出要求】\r\n风格：${parameters.outputStyle === 'news' ? '新闻报道' : parameters.outputStyle === 'blog' ? '博客文章' : '摘要总结'}\r\n长度：${parameters.length === 'short' ? '简短(300字左右)' : parameters.length === 'medium' ? '中等(500字左右)' : '详细(800字左右)'}\r\n重点关注：${parameters.focus === 'general' ? '综合内容' : parameters.focus === 'methodology' ? '研究方法' : parameters.focus === 'results' ? '研究结果' : '研究意义'}\r\n语言：${parameters.language === 'zh' ? '中文' : '英文'}\r\n\r\n请确保转换后的文章结构清晰，语言流畅，保留原文的关键信息，但使其更易于普通读者理解。\r\n    `;\r\n    \r\n    console.log('发送请求到API');\r\n    \r\n    try {\r\n      // 使用较轻量级的模型提高响应速度\r\n      const selectedModel = parameters.length === 'long' ? \"qwen-max\" : \"qwen-plus\";\r\n      console.log(`选择模型: ${selectedModel}`);\r\n      \r\n      // 直接发送主请求，跳过测试请求以减少超时风险\r\n      const response = await axios.post(API_URL, {\r\n        model: selectedModel,\r\n        messages: [\r\n          {role: 'system', content: 'You are a helpful assistant specialized in summarizing academic content to make it accessible to general audiences.'},\r\n          {role: 'user', content: prompt}\r\n        ],\r\n        // 添加max_tokens参数限制响应长度，加快响应速度\r\n        max_tokens: parameters.length === 'short' ? 800 : (parameters.length === 'medium' ? 1200 : 2000),\r\n        // 调整温度让输出更加稳定\r\n        temperature: 0.7,\r\n      }, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${API_KEY}`\r\n        },\r\n        timeout: TIMEOUT_MS, // 设置axios超时\r\n      });\r\n      \r\n      console.log('收到API响应，处理时间:', Date.now() - start, 'ms');\r\n      \r\n      // 处理结果\r\n      if (response.data && response.data.choices && response.data.choices[0]) {\r\n        const result = response.data.choices[0].message.content;\r\n        \r\n        // 保存到缓存\r\n        responseCache.set(cacheKey, result);\r\n        // 设置缓存自动过期\r\n        setTimeout(() => {\r\n          responseCache.delete(cacheKey);\r\n        }, CACHE_EXPIRY);\r\n        \r\n        return NextResponse.json({\r\n          result: result\r\n        });\r\n      } else {\r\n        console.error('API返回格式异常:', JSON.stringify(response.data));\r\n        throw new Error(\"API返回格式异常\");\r\n      }\r\n    } catch (apiError) {\r\n      console.error('API请求错误:', apiError.message);\r\n      \r\n      // 改进错误处理，提供更具体的错误信息\r\n      let errorMessage = \"API请求失败\";\r\n      let statusCode = 500;\r\n      \r\n      if (apiError.code === 'ECONNABORTED' || apiError.message.includes('timeout')) {\r\n        errorMessage = \"API请求超时，请稍后再试或减少输入内容\";\r\n        statusCode = 504;\r\n      } else if (apiError.response) {\r\n        statusCode = apiError.response.status;\r\n        errorMessage = `API响应错误(${statusCode}): ${JSON.stringify(apiError.response.data || {})}`;\r\n      }\r\n      \r\n      // 错误日志增强\r\n      console.error(`请求失败(${statusCode}): ${errorMessage}`);\r\n      \r\n      return NextResponse.json(\r\n        { error: errorMessage },\r\n        { status: statusCode }\r\n      );\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('服务器处理错误:', error.message);\r\n    \r\n    return NextResponse.json(\r\n      { error: \"服务器处理错误: \" + (error.message || \"未知错误\") },\r\n      { status: 500 }\r\n    );\r\n  }\r\n} "],"names":[],"mappings":"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","debugId":null}}]
}