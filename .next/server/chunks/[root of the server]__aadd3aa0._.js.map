{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 164, "column": 0}, "map": {"version":3,"sources":["file://D%3A/code/genreshift-web/app/api/transform/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport axios from 'axios';\r\n\r\nexport async function POST(request) {\r\n  try {\r\n    console.log('=========== API调用开始 ===========');\r\n    const { content, parameters } = await request.json();\r\n    \r\n    // 内容处理\r\n    const contentLimit = 5000;\r\n    const processedContent = content.substring(0, contentLimit);\r\n    \r\n    console.log('内容长度:', processedContent.length);\r\n    console.log('内容前100个字符:', processedContent.substring(0, 100));\r\n    console.log('参数:', JSON.stringify(parameters));\r\n    \r\n    if (!processedContent) {\r\n      return NextResponse.json(\r\n        { error: \"请提供论文内容\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    \r\n    // 获取环境变量中的API密钥和URL\r\n    const API_KEY = process.env.DASHSCOPE_API_KEY;\r\n    const API_URL = process.env.DASHSCOPE_API_URL;\r\n    \r\n    if (!API_KEY) {\r\n      console.error('API密钥未配置');\r\n      return NextResponse.json(\r\n        { error: \"API密钥未配置，请联系管理员\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n    // 测试API密钥是否有效\r\n    try {\r\n      console.log('发送测试请求检查API密钥');\r\n      const testResponse = await axios.post(API_URL, {\r\n        model: \"qwen-plus\",\r\n        messages: [\r\n          {role: 'system', content: 'You are a helpful assistant.'},\r\n          {role: 'user', content: 'Hello, are you working?'}\r\n        ],\r\n      }, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${API_KEY}`\r\n        }\r\n      });\r\n      console.log('测试响应:', JSON.stringify(testResponse.data).substring(0, 100));\r\n    } catch (testError) {\r\n      console.error('API密钥测试失败:', testError.message);\r\n      if (testError.response) {\r\n        console.error('测试响应状态:', testError.response.status);\r\n        console.error('测试响应数据:', JSON.stringify(testError.response.data));\r\n      }\r\n      return NextResponse.json(\r\n        { error: \"API密钥测试失败，请检查您的API密钥\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // 构建提示词\r\n    const prompt = `\r\n请将以下学术论文内容转换为易读的科技新闻格式：\r\n\r\n【论文内容】\r\n${processedContent}\r\n\r\n【输出要求】\r\n风格：${parameters.outputStyle === 'news' ? '新闻报道' : parameters.outputStyle === 'blog' ? '博客文章' : '摘要总结'}\r\n长度：${parameters.length === 'short' ? '简短(300字左右)' : parameters.length === 'medium' ? '中等(500字左右)' : '详细(800字左右)'}\r\n重点关注：${parameters.focus === 'general' ? '综合内容' : parameters.focus === 'methodology' ? '研究方法' : parameters.focus === 'results' ? '研究结果' : '研究意义'}\r\n语言：${parameters.language === 'zh' ? '中文' : '英文'}\r\n    `;\r\n    \r\n    console.log('发送主请求到API');\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60秒超时\r\n    \r\n    try {\r\n      console.log('接收到API请求，内容长度:', content.length);\r\n      console.log('参数:', JSON.stringify(parameters));\r\n      \r\n      // 确保内容不为空\r\n      if (!content || content.trim().length === 0) {\r\n        return NextResponse.json(\r\n          { error: \"请提供有效的论文内容\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      // 添加其他参数验证...\r\n      \r\n      const response = await axios.post(API_URL, {\r\n        model: \"qwen-max\",\r\n        messages: [\r\n          {role: 'system', content: 'You are a helpful assistant.'},\r\n          {role: 'user', content: prompt}\r\n        ],\r\n      }, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${API_KEY}`\r\n        },\r\n        signal: controller.signal\r\n      });\r\n      \r\n      clearTimeout(timeoutId);\r\n      console.log('收到API响应:', JSON.stringify(response.data).substring(0, 200) + '...');\r\n      \r\n      // 处理结果\r\n      if (response.data && response.data.choices && response.data.choices[0]) {\r\n        return NextResponse.json({\r\n          result: response.data.choices[0].message.content\r\n        });\r\n      } else {\r\n        console.error('API返回格式异常:', JSON.stringify(response.data));\r\n        throw new Error(\"API返回格式异常\");\r\n      }\r\n    } catch (apiError) {\r\n      console.error('API请求错误:', apiError.message);\r\n      console.error('API请求URL:', API_URL);\r\n      console.error('请求参数:', { \r\n        model: \"qwen-plus\", \r\n        messages: [\r\n          {role: 'system', content: 'You are a helpful assistant.'},\r\n          {role: 'user', content: prompt.substring(0, 100) + '...'} // 打印前100个字符\r\n        ]\r\n      });\r\n      \r\n      if (apiError.response) {\r\n        console.error('状态码:', apiError.response.status);\r\n        console.error('响应头:', JSON.stringify(apiError.response.headers));\r\n        console.error('响应数据:', apiError.response.data);\r\n      } else if (apiError.request) {\r\n        console.error('请求已发送但没有收到响应');\r\n      } else {\r\n        console.error('请求设置错误:', apiError.message);\r\n      }\r\n      \r\n      // 返回错误信息\r\n      return NextResponse.json(\r\n        { error: \"API请求失败，请稍后再试\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('API错误详情:', error);\r\n    console.error('错误堆栈:', error.stack);\r\n    \r\n    return NextResponse.json(\r\n      { error: error.message || \"服务器处理错误\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n} "],"names":[],"mappings":"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","debugId":null}}]
}